# 🔗 依赖关系映射文档

## 外部依赖分析

### 1. 微信生态依赖

#### 微信小程序平台
```yaml
依赖名称: 微信小程序运行时
版本要求: 基础库版本 >= 2.20.0
功能依赖:
  - 页面生命周期管理
  - 组件系统
  - 事件处理机制
  - 数据绑定
风险等级: 高
缓解措施:
  - 监控基础库版本兼容性
  - 提供版本降级方案
  - 定期测试新版本特性
```

#### 微信开放能力
```yaml
依赖名称: 微信开放API
具体API:
  - wx.login (用户登录)
  - wx.getUserInfo (用户信息)
  - wx.chooseImage (图片选择)
  - wx.getLocation (位置获取)
  - wx.saveImageToPhotosAlbum (保存图片)
  - wx.previewImage (图片预览)
限制条件:
  - 需要用户授权
  - 有调用频率限制
  - 部分API需要特定基础库版本
风险等级: 中
缓解措施:
  - 实现权限申请流程
  - 错误处理和降级方案
  - API调用频率控制
```

### 2. 云服务依赖

#### 腾讯云CloudBase
```yaml
依赖名称: CloudBase MCP Tools
服务组件:
  云函数:
    - 函数计算能力
    - 自动扩缩容
    - 冷启动优化
  云数据库:
    - MongoDB数据库
    - 自动备份
    - 索引管理
  云存储:
    - 文件存储服务
    - CDN加速
    - 权限管理
配额限制:
  - 数据库读操作: 50,000次/天
  - 数据库写操作: 20,000次/天
  - 云函数调用: 100,000次/天
  - 存储空间: 5GB免费
风险等级: 高
缓解措施:
  - 监控资源使用情况
  - 实施缓存策略
  - 代码优化减少资源消耗
  - 准备付费升级方案
```

#### 第三方API服务
```yaml
依赖名称: 腾讯地图API
功能:
  - 逆地址解析
  - 位置服务
  - 地理编码
使用限制:
  - 免费额度: 10,000次/天
  - QPS限制: 5次/秒
  - 需要API密钥
风险等级: 中
缓解措施:
  - 本地缓存地理位置信息
  - 错误重试机制
  - 备选服务商方案

依赖名称: 内容安全API
功能:
  - 敏感词检测
  - 图片内容审核
  - 文本内容审核
使用限制:
  - 按调用次数计费
  - 有审核延迟
风险等级: 低
缓解措施:
  - 本地敏感词预过滤
  - 异步审核流程
  - 人工审核备选方案
```

## 内部依赖关系

### 前端模块依赖图

```mermaid
graph TB
    subgraph "页面层"
        A1[首页]
        A2[创建记录页]
        A3[历史记录页]
        A4[分享页面]
        A5[个人中心页]
    end
    
    subgraph "业务组件层"
        B1[运动类型选择器]
        B2[图片上传组件]
        B3[数据输入表单]
        B4[分享图片预览]
        B5[记录列表项]
    end
    
    subgraph "基础组件层"
        C1[按钮组件]
        C2[输入框组件]
        C3[图片组件]
        C4[卡片组件]
        C5[模态框组件]
    end
    
    subgraph "服务层"
        D1[运动记录API]
        D2[图片上传API]
        D3[位置服务API]
        D4[分享生成API]
        D5[用户管理API]
    end
    
    subgraph "状态管理层"
        E1[运动记录状态]
        E2[分享功能状态]
        E3[用户状态]
        E4[UI状态]
    end
    
    subgraph "工具层"
        F1[验证工具]
        F2[格式化工具]
        F3[日期工具]
        F4[Canvas工具]
        F5[存储工具]
    end
    
    A1 --> B1
    A2 --> B1
    A2 --> B2
    A2 --> B3
    A3 --> B5
    A4 --> B4
    
    B1 --> C1
    B2 --> C3
    B3 --> C2
    B4 --> C3
    B5 --> C4
    
    B1 --> D1
    B2 --> D2
    B2 --> F1
    B3 --> F1
    B4 --> D4
    B4 --> F4
    B5 --> D1
    
    D1 --> E1
    D2 --> E1
    D3 --> E3
    D4 --> E2
    D5 --> E3
    
    E1 --> F2
    E1 --> F3
    E2 --> F4
    E3 --> F5
    E4 --> C5
```

### 云函数模块依赖图

```mermaid
graph TB
    subgraph "入口层"
        G1[主入口函数]
        G2[路由分发器]
    end
    
    subgraph "业务处理器层"
        H1[创建记录处理器]
        H2[查询记录处理器]
        H3[更新记录处理器]
        H4[删除记录处理器]
        H5[统计分析处理器]
        H6[分享生成处理器]
    end
    
    subgraph "服务层"
        I1[数据验证服务]
        I2[数据库服务]
        I3[文件存储服务]
        I4[位置解析服务]
        I5[统计计算服务]
        I6[Canvas生成服务]
    end
    
    subgraph "工具层"
        J1[验证工具]
        J2[数据库工具]
        J3[云存储工具]
        J4[错误处理工具]
        J5[缓存工具]
        J6[限流工具]
    end
    
    subgraph "数据访问层"
        K1[运动记录集合]
        K2[用户集合]
        K3[统计集合]
        K4[文件存储]
    end
    
    G1 --> G2
    G2 --> H1
    G2 --> H2
    G2 --> H3
    G2 --> H4
    G2 --> H5
    G2 --> H6
    
    H1 --> I1
    H1 --> I2
    H1 --> I3
    H2 --> I2
    H3 --> I1
    H3 --> I2
    H4 --> I2
    H5 --> I2
    H5 --> I5
    H6 --> I6
    
    I1 --> J1
    I2 --> J2
    I3 --> J3
    I4 --> J4
    I5 --> J5
    I6 --> J6
    
    J2 --> K1
    J2 --> K2
    J2 --> K3
    J3 --> K4
```

## 依赖风险分析

### 高风险依赖

#### 1. Canvas API兼容性
```yaml
风险描述: 微信小程序和H5的Canvas API存在差异
影响范围: 分享图片生成功能
概率: 高
影响程度: 高
缓解策略:
  - 封装Canvas操作工具类
  - 平台特性检测
  - 提供降级方案
  - 充分测试验证
监控指标:
  - Canvas绘制成功率
  - 绘制耗时
  - 错误率
```

#### 2. 微信API变更
```yaml
风险描述: 微信API升级可能导致兼容性问题
影响范围: 整个应用的核心功能
概率: 中
影响程度: 高
缓解策略:
  - 关注微信官方更新公告
  - 使用版本检测和适配
  - 建立API变更响应机制
  - 保持基础库版本兼容
监控指标:
  - API调用成功率
  - 用户授权成功率
  - 功能异常报告
```

### 中等风险依赖

#### 1. 云开发配额限制
```yaml
风险描述: 免费额度可能无法满足业务增长需求
影响范围: 应用整体可用性
概率: 中
影响程度: 中
缓解策略:
  - 实施严格的资源监控
  - 优化代码减少资源消耗
  - 建立配额预警机制
  - 准备付费升级方案
监控指标:
  - 数据库读写次数
  - 云函数调用次数
  - 存储空间使用量
  - 费用支出趋势
```

#### 2. 第三方服务稳定性
```yaml
风险描述: 地图API、内容审核服务可能出现不稳定
影响范围: 位置服务、内容安全
概率: 低
影响程度: 中
缓解策略:
  - 建立服务健康检查
  - 实施错误重试机制
  - 准备备选服务商
  - 提供降级功能
监控指标:
  - API响应时间
  - 服务可用性
  - 错误率
  - 重试成功率
```

## 版本兼容性矩阵

### 微信小程序兼容性

| 功能 | 最低基础库版本 | 推荐版本 | 备注 |
|------|---------------|----------|------|
| Canvas 2D | 2.9.0 | 最新版本 | 分享图片生成 |
| 图片选择 | 2.4.0 | 最新版本 | 相册和相机 |
| 位置服务 | 2.0.0 | 最新版本 | GPS定位和地址解析 |
| 文件上传 | 2.4.0 | 最新版本 | 图片上传到云存储 |
| 登录授权 | 2.0.0 | 最新版本 | 用户身份验证 |

### 浏览器兼容性

| 浏览器 | 最低版本 | 支持功能 | 备注 |
|--------|----------|----------|------|
| Chrome | 70+ | 全部功能 | 推荐浏览器 |
| Safari | 12+ | 全部功能 | iOS设备 |
| Firefox | 65+ | 全部功能 | 可选浏览器 |
| Edge | 79+ | 全部功能 | Chromium内核 |
| IE | 不支持 | - | 建议使用现代浏览器 |

## 部署依赖关系

### 开发环境依赖
```yaml
Node.js: >= 16.0.0
npm: >= 8.0.0
Git: >= 2.20.0
微信开发者工具: 最新稳定版
VS Code: 推荐编辑器
```

### 生产环境依赖
```yaml
微信小程序平台: 已认证的小程序账号
CloudBase环境: 已开通的云开发环境
域名备案: 如需H5独立域名
SSL证书: HTTPS安全证书
CDN服务: 静态资源加速
监控服务: 应用性能监控
```

## 监控和告警

### 关键指标监控

#### 1. 业务指标
- 用户活跃度（日活、月活）
- 功能使用率（记录创建、分享生成）
- 用户留存率（次日、7日、30日）
- 分享转化率

#### 2. 技术指标
- API响应时间
- 错误率和异常率
- 页面加载时间
- 服务可用性

#### 3. 资源使用指标
- 云开发资源使用量
- 第三方API调用量
- 存储空间使用量
- 费用支出情况

### 告警配置

```yaml
高优先级告警:
  - 服务不可用 > 1分钟
  - API错误率 > 5%
  - 数据库连接失败

中优先级告警:
  - API响应时间 > 2秒
  - 资源使用量 > 80%
  - 第三方服务异常

低优先级告警:
  - 性能指标异常
  - 用户投诉增加
  - 监控数据缺失
```

---

**文档维护者**: 技术团队  
**最后更新**: 2025-09-09  
**审核状态**: 已审核  
**版本**: v1.0.0  

**相关文档**:
- [技术决策记录](./technical-decisions.md)
- [实施史诗](./epic.md)
- [项目架构文档](../architecture.md)