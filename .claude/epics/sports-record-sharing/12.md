---
name: 数据存储逻辑
status: open
created: 2025-09-09T09:19:22Z
updated: 2025-09-10T06:15:48Z
github: https://github.com/terry237tm/sports-record-sharing-app/issues/12
depends_on: [001, 002, 003, 004, 005]
parallel: true
conflicts_with: []
---

# 数据存储逻辑

## Description
实现运动记录的数据存储逻辑，包括云函数开发、数据库操作、事务处理、数据一致性保证等。建立完整的数据访问层，确保数据安全可靠地存储和读取。

## Acceptance Criteria
- [ ] 运动记录创建云函数开发完成，支持完整数据写入
- [ ] 数据库集合设计和索引优化，保证查询性能
- [ ] 事务处理机制，确保数据一致性
- [ ] 软删除机制实现，支持数据恢复和审计
- [ ] 数据验证逻辑，在云函数端进行二次验证
- [ ] 错误处理和日志记录，完整的异常处理机制
- [ ] 数据分页查询功能，支持游标分页
- [ ] 批量操作支持，提高数据处理效率
- [ ] 数据缓存策略，减少数据库访问压力
- [ ] 数据备份和恢复机制，保证数据安全

## Technical Details
### 数据库模型设计
```typescript
// 运动记录集合 (sport_records)
interface SportRecord {
  _id: string;                    // 记录ID
  _openid: string;                // 用户openid
  sportType: SportType;           // 运动类型
  data: {
    duration: number;             // 运动时长(分钟)
    distance?: number;            // 运动距离(公里)
    calories: number;             // 消耗卡路里
    heartRate?: number;           // 心率
    steps?: number;               // 步数
    averagePace?: number;         // 平均配速
    maxHeartRate?: number;        // 最大心率
  };
  images: string[];               // 图片URLs
  description: string;            // 运动描述
  location?: {                    // 地理位置
    latitude: number;
    longitude: number;
    address: string;
    city?: string;
    district?: string;
    province?: string;
  };
  weather?: {                     // 天气信息
    temperature?: number;
    condition?: string;
    humidity?: number;
  };
  tags: string[];                 // 标签
  isPublic: boolean;              // 是否公开
  likes: number;                  // 点赞数
  comments: number;               // 评论数
  shares: number;                 // 分享数
  createdAt: Date;                // 创建时间
  updatedAt: Date;                // 更新时间
  isDeleted: boolean;             // 软删除标记
  deletedAt?: Date;               // 删除时间
}
```

### 云函数架构设计
```
cloudfunctions/
├── createSportRecord/     # 创建运动记录
├── getSportRecord/        # 获取单条记录
├── getSportRecords/       # 获取记录列表
├── updateSportRecord/     # 更新记录
├── deleteSportRecord/     # 删除记录
├── batchOperations/       # 批量操作
└── dataStatistics/        # 数据统计
```

### 创建记录云函数实现
```typescript
// 云函数入口
export async function createSportRecord(event: CreateRecordEvent, context: any) {
  const { data, images, location, description } = event;
  const openid = context.userInfo.openId;
  
  try {
    // 1. 数据验证
    const validationResult = await validateSportRecord(data);
    if (!validationResult.valid) {
      return {
        success: false,
        error: '数据验证失败',
        details: validationResult.errors
      };
    }
    
    // 2. 内容安全检测
    const contentCheck = await checkContentSafety(description, images);
    if (!contentCheck.safe) {
      return {
        success: false,
        error: '内容包含违规信息',
        details: contentCheck.violations
      };
    }
    
    // 3. 数据库操作（事务）
    const db = cloud.database();
    const transaction = await db.startTransaction();
    
    try {
      // 3.1 创建运动记录
      const recordResult = await transaction.collection('sport_records').add({
        data: {
          _openid: openid,
          sportType: data.sportType,
          data: data,
          images: images || [],
          description: description || '',
          location: location || null,
          isPublic: true,
          likes: 0,
          comments: 0,
          shares: 0,
          createdAt: new Date(),
          updatedAt: new Date(),
          isDeleted: false
        }
      });
      
      // 3.2 更新用户统计信息
      await transaction.collection('user_statistics').where({
        _openid: openid
      }).update({
        data: {
          totalRecords: _.inc(1),
          totalDuration: _.inc(data.duration || 0),
          totalCalories: _.inc(data.calories || 0),
          lastRecordAt: new Date(),
          updatedAt: new Date()
        }
      });
      
      // 4. 提交事务
      await transaction.commit();
      
      return {
        success: true,
        data: {
          recordId: recordResult._id,
          createdAt: new Date()
        }
      };
      
    } catch (error) {
      // 回滚事务
      await transaction.rollback();
      throw error;
    }
    
  } catch (error) {
    console.error('创建运动记录失败:', error);
    
    return {
      success: false,
      error: '创建记录失败，请稍后重试',
      details: error.message
    };
  }
}
```

### 数据库索引优化
```javascript
// 复合索引设计
db.sport_records.createIndex({
  _openid: 1,
  createdAt: -1
}); // 用户记录查询

db.sport_records.createIndex({
  sportType: 1,
  createdAt: -1
}); // 运动类型查询

db.sport_records.createIndex({
  location: '2dsphere'
}); // 地理位置查询

db.sport_records.createIndex({
  isPublic: 1,
  createdAt: -1
}); // 公开记录查询
```

### 分页查询实现
```typescript
class RecordPaginationService {
  private pageSize: number = 20;
  
  async getRecordsPage(params: PaginationParams): Promise<PaginationResult> {
    const { openid, cursor, sportType, startDate, endDate } = params;
    
    // 构建查询条件
    const query: any = { 
      _openid: openid, 
      isDeleted: false 
    };
    
    if (sportType) {
      query.sportType = sportType;
    }
    
    if (startDate || endDate) {
      query.createdAt = {};
      if (startDate) query.createdAt.$gte = startDate;
      if (endDate) query.createdAt.$lte = endDate;
    }
    
    // 游标分页
    if (cursor) {
      query._id = { $lt: cursor };
    }
    
    const db = cloud.database();
    const result = await db.collection('sport_records')
      .where(query)
      .orderBy('createdAt', 'desc')
      .orderBy('_id', 'desc')
      .limit(this.pageSize + 1) // 多查一条用于判断是否还有下一页
      .get();
    
    const hasMore = result.data.length > this.pageSize;
    const records = hasMore ? result.data.slice(0, -1) : result.data;
    const nextCursor = hasMore ? records[records.length - 1]._id : null;
    
    return {
      records,
      hasMore,
      nextCursor,
      total: records.length
    };
  }
}
```

### 缓存策略
```typescript
// Redis缓存封装（模拟）
class CacheService {
  private cache = new Map();
  private defaultTTL = 300; // 5分钟
  
  async get(key: string): Promise<any> {
    const item = this.cache.get(key);
    if (!item) return null;
    
    if (Date.now() > item.expireAt) {
      this.cache.delete(key);
      return null;
    }
    
    return item.value;
  }
  
  async set(key: string, value: any, ttl?: number): Promise<void> {
    this.cache.set(key, {
      value,
      expireAt: Date.now() + (ttl || this.defaultTTL) * 1000
    });
  }
  
  async invalidate(pattern: string): Promise<void> {
    for (const key of this.cache.keys()) {
      if (key.includes(pattern)) {
        this.cache.delete(key);
      }
    }
  }
}
```

### 数据一致性保证
- **事务操作**：关键操作使用数据库事务
- **乐观锁**：使用版本号机制防止并发修改
- **幂等性**：重复请求不会产生副作用
- **补偿机制**：失败操作的重试和补偿逻辑

### 监控和日志
```typescript
// 操作日志记录
async function logOperation(operation: string, data: any, result: any) {
  const db = cloud.database();
  
  await db.collection('operation_logs').add({
    data: {
      operation,
      params: data,
      result: {
        success: result.success,
        error: result.error,
        timestamp: new Date()
      },
      createdAt: new Date()
    }
  });
}
```

## Dependencies
- 依赖任务001-005完成（云函数基础架构）
- 依赖任务006-009的数据模型定义

## Effort Estimate
- **Size**: XL (超大)
- **Estimated Hours**: 20-24 小时

## Definition of Done
- [ ] 所有云函数开发完成，功能测试通过
- [ ] 数据库设计和索引优化完成，性能测试达标
- [ ] 事务处理机制正确实现，数据一致性有保障
- [ ] 错误处理和日志记录完善，问题可追溯
- [ ] 数据验证逻辑严密，防止非法数据入库
- [ ] 分页查询性能优化，大数据量下响应迅速
- [ ] 缓存策略有效实施，数据库压力显著降低
- [ ] 数据备份和恢复机制建立，数据安全有保障
- [ ] 监控告警配置完成，异常情况及时通知
- [ ] API文档和使用说明编写完整
- [ ] 单元测试和集成测试覆盖率达到80%以上
- [ ] 性能测试通过，满足高并发场景需求
- [ ] 代码审查完成，符合安全和性能最佳实践
- [ ] 部署脚本和配置管理自动化完成
